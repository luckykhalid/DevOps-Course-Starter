env:
  global:
  - secure: JjbU69ZIQ63AoiN9iBwg3QdbVOmV/mJKdv62CjaliD1iP7Szm0mr8ZZ3zpquxdi+JCVzBqc9nQOmKBtSc+DAK3dtFnr/zq6kboSEexzj92orBgsB4fLyJKky8I0POTLyv/6CGEWKfuF1g1XFjHou/8DQLc6YQ6JSn/lIojPXuJrawb7Dz9HXq87SAZH43m5UPnev0JhlI1ePZiWPPPsgeDKCewioUBWafjx1O6NlI3Ael093HYlST+RgzW4mAWK1j3/fAHLlQlOn6yW+VvZhyaqToQ0cyqM0GQYIwo53q/ssjiUeaiEQKI7qpH/zhxfHaRJ0qfHrBxnMf69WC08V1DjlBuUwKOuWDU9VxeCcXFYxHdPApSmw68C5bMr7baaYeHmUrpeldox6gFyElxj8QLiFAFIEC4Qi3x24m8er8FtP8dPgSyfttBdF6znAPQFDKWPA4XuIN2x9IARbITElcH0tEAg8YmkK0ImCANV3x/gzMlRSyEiUzI3o+IYtmf66xa4yvW2ldCfFWaTAPIbVSPOKHCm+SFZEhfP8YbagTpzJGkHEmuG7ezMmBkN/F12jwNS1zE0w4KDF0TvaRjgzltawvKmuE5fy9pp3QHGy6m5W+b8v/NwneM4f7EifXXwMNAAxEbiFwSEaZHqNQaodAq/QIdBKqv0NJfbj+UJD08k=
  - secure: VKmGEtN5MEzRyII3rCYNvJPHu3/hBgB5RVmExN5ojkqOZm3fcbSIyr0b0eI3oRFVE1dWES6J07/V1GFa7h/O1HQR14KO2seb/Xm46sap6sRCM4tL0rMhvGSBMKMGX+/X/iAlJHUtCQojCPu4hVq4OWy34JNfylGAn0KSPdOnB2cwtvwty1Sji7lwYxa9rTc/6IqPbgddX7J4BVCH/bMhvJ5FRCo2loJPB/6YeMA81nL/ztg4dP6fnERTGmd2VNq2RYmuzNL96PtN/j8HuyA2RcQ3f/eKJ8uEyrt7eOVawuCibXoo6dNsbkToz3ybj8Io1tvZfuLWOg9QiB20we9Dxrs7S59IlYBMCrzr4xvgp61Diymw5of8F9ygYkKrJpJMnUeMFwWbZnCBnEKFCt697BsgQDjtYZGSP+Ld9kqw5o++wBw/r/vPMo1EOODdrmzk9HN0gBpyA/mV2r26LzRAu04Um4gNaJhHbq+LvaASpf+NA0CPiB017BNYRqGoO+Hz6utz/AAY5U30dEnUftqZE+3vS5C2Yydk8NnCsGIu+BofwaQgGAyYLq6Kc+sDPQ/KjhpAn6AhUimhUNfd4E+dldD4DlJK8M+pYIQf+osbWfaQO/OusBdjSa0KY3IDWH7VhQttlYJP1CPfMxShYCs4GypyBUXp7SBo5QzLr/mxJ3U=
  - DOCKER_USER=khalidashraf
  - secure: WrccS5O4eSH8/HKUukA+cJxa+2wCkj/f4lYgWBeGFpoX2xFVICYiYfp5cHSL6VYFCieq24LCufdhB7JvJ+JWjbmmrElC4aluNSfRgpwQBlN7OTVmMwCEzII3Uu8tIww8md7/mIdG/6YBSDPWFPo17tFI69bx0t1AXUWts3WLHTuVilp3EFrlZXpnUKR3d91hSQ+9hG3UnGP8fLAlC/D2b/3gVuCZ7tv9zrcQWh4zFDYIjxT6SKeiOOwwlC9i9qGb6pcDxFxHjMVgXtLU1ue6Gh9KPXyd3WRyPmKd/mxrH8qCw6tad+/gsSk25Vkue+dKQs8F4+Qkc8L2IwcdwIq8ty12Wfu2Wc7GSC7mSCdwq1AySRqOVcAWIlCSGPHP7Rv3bC7RQ0i1CQaRlV4ch/3LfXBva1DfFG01gAKqimmwvT0yCxN8g+MT7pnYfSofnCFFZsuCpahyT1B36wkB9hBAxeUYRO1vi1+scu48J++YfXBqXyvgZm+CnsHv1UsWAYdt5YT1VRnOumJ564wZS64x4MUyKqsFDZvdpB6VICmtwJYk2fcQ4UQ1jL6Hvkezqh7BJew1Osw3LSRr3Y/90iywMAF70/bEKS0E3s2xZVVfblxDOEtlBoEFIgNyBR/TX2fQ2Vi2xo9i0gtV8JtFmwUaYnKzmEsckGaTSyruuYAgbjs=
  - HEROKU_APP=khalidashraf-todo-app
  - secure: j9yGr8VrXd5o6pr6yAzAnK7DzyaDgZ8uKf5sp8tWKhu3wEuQenx3jFKndrl6w82AP3J+srBVw+yDv4e5GwGSSZ6HtF4F6AEUp+MVjg90NJwEjJuHO3FwsdkZNGncIEix044M7oA2nmoWQPZoSZ6XQRGZRa6xJrA4Y04s2Fwk+q9EdFnX4cRCcDc+7V9zkgdTEJneOEOpR2ElMz0z4/NWb357jmK37GdY4nvT3C+gEUqhKGp/de1FoNSLnlWmoKFXEtbUNqI4jhepf+QO4+KFlSJJBYOOPD308dt12vAdthv2VxKNYWh62KF4IfL/HAhPY13ZmWYtZC/K4aT1geoLkL1RHRIrvJQcCdSwQ+KwHRRsLE24SY1KeLxDOYCk5VZZ0wjjI1efeRjQc/MoGXSI0ems9bI5aWBQn2EVymHpRg8k+eMCcb2NUa8QU409hE73z0g0NvyIZRHzYS1CCZuEsbrXGcP0EOn8SD0+6mTo8PyqFzQ226t33/XEkbbU1ZGOHb7/eZKh3vU/iWx1AP4hakD9OF4dg3/2qgnnFItAkW5ZEu01O7AeHYr4As3n7mQqXVboq0Sb/eR3CC7JnZ4QoT30nc/5SBoYZYO9QkTW/Sh8e1bd+vVaAboOIF5S1+0nSTIy3mKQLsx7xygvLEGeaDsioL1JqWen7FKh68DD0Js=
  - secure: Q+jfk7gIgAfkhoEEomitPwvh/PpOWG5pKgM08DX4DjvP+aSoc/nk9ijZnPzAwxZaoGKzb9M6MLNtRq4HSNLntCO55WWL2H43GlpYSuifZfGhg+684gx0oraz0H/QzppSEjayWNswEq6PVGp3TmVjSbfaDgowFW/VzPhJnS9dSUnlD0odStwGJTSMyFSGp2jWAZ8PoX7x5rf/Op1KhQXBHyP6dwL7B9tZkw+wu3mYb0fsvWONUHEJbjEiBg1gL5esrH6IIEU7F3KxN4WeYIDC3GTVwWjlolVo7pBds3YeFOX8shjlXWsaNam9BKDrkMuDKBYYzFzoZoAq8zXN6DbTKPKKYY4GotxStxuyh/Pzo6GjDFSi/X/b8R5y3249R8XkO1BDYo+7tFbnFI/q8kBvGx937cmwxQcKKxDUctIGZ/frLcR7NXtHHKOIni5hX6YWhRXH8EzJ2qYYMRNP2oRqnXNZ6HcolMeZgPYePLU39jK5sxzf+DApM3EJMDgjwANUCqwc1bx7gaR3ImMI2bf5+7uvXQXOLaW5QlFTYYDLmxVm+HR66h1/ObSa2gl8dIzjA4y6jg3mh8eC31ApEfvPYe9/6JJxmJ8P9WxvHCcTQNrwIu3FDhC06+NF9ZsLDL8W142TV9MmqdO9PEwFyfqPRxRxZzv9fGjhwHAwgFJ1KP0=
  - OAUTH_AUTHENTICATE_URL=https://github.com/login/oauth/authorize
  - OAUTH_ACCESS_TOKEN_URL=https://github.com/login/oauth/access_token
  - OAUTH_USER_URL=https://api.github.com/user
  - ROLE_WRITER_USERS=luckykhalid
  - secure: E7arcKb4m0YGHIq6m8lgtyWQidsG6r42J2XEyomBylLk54K9Yz6b/GeErzj+RCtloomu958dDuweU4k92vLKF5TZmWAVpTcE7PP0Up2eJVouRdCx19tfSKlB7bXUuX93OyAZcwDNibTlkOem3lP8nxoEBZX+xLjv+X+asIpOWXLz/nLJia71Ay/SLVZyAG5slQR+QVmEC/+WAl7GNKKevADWkkqkOQbv6xnzEe7zntfplnJ55Hsyk9HwbjlSMXoearDMSjJio0CZ16gqK+gakSlsI85y1EMyg3l/3o5SDXtggGbmqX25ydOYzZZJMto82TqnamP7oF8/KN6aI76muaTM51Fe9dLqD+BWdAG34ig8tsviEE5ZTZte6lD31xB52jOQjUbWZEuiNPjyQ4NfGm778b4qJVdgmKE9G7Hgh5Tw0d3SWg7K6BTeTzH4ZuS0AzQabdnI3INecPGF+P5JFUijG94jLgtuErNRKJvyaWLRLrz7Pt9AR1XCqSuAZ1DsxITD4CyWxddq7uczPwrVzZAmuH2SCwK7U0zFYf+4OEXqXAgg0ukyah8S8WuNwMkDER386XhcrwtMpcYR0iaA6tCIlzNqQIywqNhqzN1ChC2zJFkRARVoYtBvWfKkZLxUVXBb/j5dQK6dHvqBbGuMGDWK0nHJ4+1HVuoFuekfi0A=  
  - ARM_CLIENT_ID=470156fd-59fb-4c9e-a5d9-70a13d0c3217
  - ARM_TENANT_ID=7d6f97d6-d755-4c10-b763-409cc4b6638f
  - ARM_SUBSCRIPTION_ID=d33b95c7-af3c-4247-9661-aa96d47fccc0
  - ARM_CLIENT_SECRET=BWp95lgxOwf~6JohO.wrvFV8iuzA0x8CUc
  - TF_VERSION=0.14.7
services:
- docker
  
script:  
  # Build test image and test the code  
  - docker build --target test --tag todo_app:test .
  - docker run --env-file .env.test todo_app:test tests
  - docker run -e SECRET_KEY -e MONGODB_CONNECTION_STRING -e OAUTH_CLIENT_ID -e OAUTH_CLIENT_SECRET -e OAUTH_AUTHENTICATE_URL -e OAUTH_ACCESS_TOKEN_URL -e OAUTH_USER_URL -e ROLE_WRITER_USERS todo_app:test tests_e2e
  # Redeploy to Azure
  #- bash ./webhook.sh  
  - terraform apply -var "prefix=khalid" -var "secret_key=$SECRET_KEY" -var "oauth_client_id=$OAUTH_CLIENT_ID" -var "oauth_client_secret=$OAUTH_CLIENT_SECRET" -var "oauth_authenticate_url=$OAUTH_AUTHENTICATE_URL" -var "oauth_access_token_url=$OAUTH_ACCESS_TOKEN_URL" -var "oauth_user_url=$OAUTH_USER_URL" -var "role_writer_users=$ROLE_WRITER_USERS" -auto-approve

install:
- wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
- unzip terraform_"$TF_VERSION"_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_"$TF_VERSION"_linux_amd64.zip
- terraform init

deploy:
  provider: script
  script: bash ./build-deploy.sh
  on:
    branch: master

notifications:
  slack:
    secure: o5cEaHOFMzW435cV5zT/4MaoyHC3X3DS9091yDH6SxwLy6F/rngAy5EwDZ53opq/YdWYyGhlumsiZFfVyI2qpyZSkE2Epk9p35YT0Gdx/x9oad91G8PeyaWSBN2GWfceZ/qBxTfamyACUPr2ItWi7oPw65RnYM/kRcbfmXnxC9bqQcDX0bLWVDRZtVmmsZJ0kNnCwznsBb9gpVV7Vz3ZVhv9QvFoYPyIDdyMT2vlYHu/iQ8FJIX9eKuYuqViklUiwWYIejUqp7892x3m5Bywm7e0Y0NqXmWbXsiW8MizQsn9E6M93Ed4+xNyKWz7f6O7GvVZm1GmdyH5FPB3Nz38FxOy6e4bYC8r399DJISZl0VMYtqDhKndoqRvSpR4tvvmad5x37mAMs2o1IpRc2OQTJ5Rtz54Hqw+gAHa3lvyFuz1QvMjaZnp9zXLy6dJYF6VIJu6FKDKQJwLbiYio18EqkxauxUGM0VB+12JiVds53aXNqlPkqopzhNdCKnSUlKH0yho6SJzzyYRnKG9vOGaIbx88Sf+PrEIYylXdFlsfH/I3bhFMkRN2EoHZpYaaDXPqxk/IXCUHNHU39cuu9CpQYFXt3rlirljBD/o2Oi3oiMXT36jFL37Oc4C3jxiv2cj0LLacgB/e0qwGqhjqjLerKiYPjh1vvdOt9aGvpXcIAA=
  email:
    recipients:
    - khalid.ashraf@hotmail.com
    on_success: never
    on_failure: always
